# CocosCreator-HotUpdate
CocosCreator HotUpdateçƒ­æ›´æ–°ï¼Œä»å…¥é—¨åˆ°æ”¾å¼ƒï¼Ÿ
###å‰è¨€ï¼š
å—¯ï¼Œä¹‹å‰çš„æ¸¸æˆæ˜¯åŸºäºcocos2d-xå¼•æ“çš„C++ç¯å¢ƒä¸‹å¼€å‘çš„ï¼Œä¸€ç›´è¢«äº§å“åæ§½ç€ä¸èƒ½çƒ­æ›´æ–°â˜¹ï¸ã€‚æ²¡åŠæ³•ç»ˆäºåœ¨åŠå¹´ä¹‹åå†³å®šæ”¹ç”¨CocosCreatorçš„JavaScriptç¯å¢ƒæ¥å¼€å‘ï¼Œä½ çˆ±å•¥æ—¶å€™æ›´æ–°å°±å•¥æ—¶å€™æ›´æ–°ã€‚ä¹Ÿå› ä¸ºè¸ä¸Šäº†CocosCreatorè¿™åªè´¼èˆ¹ï¼Œå°±æœ‰äº†åé¢æºæºä¸æ–­çš„æ•…äº‹(ï¼›â€²âŒ’`)ã€‚

#ä¸´æ—¶æœ‰äº‹ï¼Œæˆ‘æ™šç‚¹å†å†™ã€‚
#ä¸´æ—¶æœ‰äº‹ï¼Œæˆ‘æ™šç‚¹å†å†™ã€‚
#ä¸´æ—¶æœ‰äº‹ï¼Œæˆ‘æ™šç‚¹å†å†™ã€‚

ä¸´æ—¶è®°å½•ä¸€ä¸‹æ€ä¹ˆä¿®æ”¹manifestæ–‡ä»¶ä¸­çš„å†…å®¹ï¼ˆä¸»è¦ä¹Ÿå°±æ˜¯å‡çº§åŒ…çš„åœ°å€ï¼Œåˆ«çš„ä¿®æ”¹äº†ä¹Ÿä¸èƒ½ä¸Šå¤©â˜¹ï¸ï¼‰ã€‚
éœ€æ±‚æ˜¯è¿™æ ·çš„ï¼šç”±äºæˆ‘æ‰€ä¸çŸ¥é“çš„åŸå› ï¼ŒæœåŠ¡å™¨é‚£è¾¹è¦çªç„¶å°†åé¢çš„å‡çº§åŒ…æ›´æ¢æœåŠ¡å™¨è·¯å¾„ï¼Œå¿ƒé‡Œæ…Œå¾—å¾ˆï¼Œæ¯•ç«Ÿä¹‹å‰å‡çº§åŒ…åœ°å€éƒ½æ˜¯å†™æ­»åœ¨.manifestæ–‡ä»¶ä¸­çš„ï¼Œä¹Ÿæ²¡æœ‰åšåŠ¨æ€é…ç½®ï¼Œæ‰€ä»¥æœ¬æ¬¡åªèƒ½å¼ºåˆ¶ç”¨æˆ·å‡çº§Appï¼Œå¹¶å°†Appå†…çš„.manifestæ–‡ä»¶å†…å‡çº§åŒ…åœ°å€æ”¹ä¸ºå¯ä»¥é…ç½®çš„ã€‚ä»¥åé‚£äº›æœåŠ¡å™¨ç«¯å¼€å‘äººå‘˜æƒ³é€†å¤©éƒ½è¡Œäº†ã€‚

#####æ”¹åŠ¨ä¹‹å‰ï¼Œæˆ‘è€ƒè™‘è¿‡è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼ŒAppå†…çš„project.manifestæ–‡ä»¶å¯èƒ½å­˜åœ¨ä¸¤ä»½ã€‚æ€è€ƒä¸€ä¸‹ä¸ºä»€ä¹ˆï¼Ÿ

çœ‹æˆ‘è§£ç­”ï¼šé¦–å…ˆæˆ‘ä»¬åœ¨å‘å¸ƒå…·å¤‡çƒ­æ›´æ–°çš„Creatoræ¸¸æˆé¡¹ç›®çš„æ—¶å€™ï¼Œæ¸¸æˆé‡Œé¢éƒ½ä¼šæœ‰ä¸€ä»½ï¼ˆproject.manifestã€version.manifestï¼‰æ–‡ä»¶ã€‚å¦‚æœæœ‰äº›ç”¨æˆ·ä½¿ç”¨è¿‡ç¨‹ä¸­è¿›è¡Œäº†çƒ­æ›´æ–°ï¼Œé‚£ä¹ˆAppå†…éƒ¨æŒ‡å®šçš„çƒ­æ›´æ–°ç›®å½•ä¸‹å°±ä¼šå­˜åœ¨ä¸€ä»½æ–°çš„ï¼ˆproject.manifestï¼‰æ–‡ä»¶ï¼Œå½“ç„¶ï¼Œä¸‹ä¸€æ¬¡çš„å‡çº§åŒ…åœ°å€ä¹Ÿæ˜¯æ ¹æ®è¿™ä»½æ–°çš„ï¼ˆproject.manifestï¼‰æ–‡ä»¶æä¾›çš„ã€‚æ‰€ä»¥æƒ³åŠ¨æ€ä¿®æ”¹(project.manifestã€version.manifest)æ–‡ä»¶ä¸­çš„å†…å®¹ï¼ˆä¸»è¦æ˜¯æ›´æ–°åŒ…åœ°å€ï¼‰,å°±éœ€è¦è€ƒè™‘ä¸¤ç§æƒ…å†µï¼š
######â‘  ç”¨æˆ·ä»æœªè¿›è¡Œè¿‡çƒ­æ›´æ–°ï¼Œè¿™ä¸ªæ—¶å€™Appå†…çš„.manifestæ–‡ä»¶åªæœ‰ä¸€ä»½ï¼Œæˆ‘ä»¬åªéœ€è¦ä¿®æ”¹è¿™ä¸ª.manifestæ–‡ä»¶å³å¯ã€‚
######â‘¡ç”¨æˆ·åœ¨å®‰è£…è¯¥AppæœŸé—´ä½¿ç”¨è¿‡çƒ­æ›´æ–°ï¼Œè¿™æ—¶å€™Appå†…éƒ¨å°±ä¼šå­˜åœ¨ä¸¤ä»½project.manifestæ–‡ä»¶äº†ï¼Œæ­¤æ—¶æˆ‘ä»¬è¦ä¿®æ”¹çš„project.manifestã€version.manifestæ–‡ä»¶ä½äºå½“åˆæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­æŒ‡å®šçš„çƒ­æ›´æ–°ç›®å½•ä½ç½®ã€‚å¦‚æˆ‘çš„é¡¹ç›®æ˜¯ï¼š
```
let storagePath = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + 'remoteAssets');
```
#####å…³äºä»¥ä¸Šä¸¤ç§æƒ…å†µä¸‹ä¿®æ”¹.manifestæ–‡ä»¶çš„æ–¹æ³•æä¾›å¦‚ä¸‹ï¼Œå¯å‚è€ƒæˆ‘ç»™çš„æ€è·¯ğŸ˜ï¼š


######å¦‚æœä¹‹å‰æ²¡æœ‰çƒ­æ›´ï¼Œé‚£ä¹ˆæ‰‹æœºä¸Šä¹Ÿå°±æ²¡æœ‰çƒ­æ›´çš„æ–‡ä»¶(version.manifestã€project.manifestã€resã€src)ï¼›æ­¤æ—¶å¦‚æœæœåŠ¡å™¨ç«¯å‘å¸ƒçƒ­æ›´æ–°åŒ…ï¼Œå¹¶ä¸”çƒ­æ›´æ–°åŒ…çš„åœ°å€ä¸APPæ‰“åŒ…æ—¶å€™æ”¾å…¥çš„project.manifestæ–‡ä»¶ä¸­åœ°å€ä¸ä¸€è‡´ï¼Œé‚£å°±éœ€è¦å°†project.manifestæ–‡ä»¶åœ°å€ä¿®æ”¹ä¸ºæœåŠ¡å™¨ä¸‹å‘çš„æ–°åœ°å€ã€‚é—®é¢˜åœ¨äºæ‰“åŒ…æ—¶å€™çš„project.manifestæ–‡ä»¶åœ¨apk(Android)æˆ–ipa(iOS)ä¸­,åªæœ‰è¯»çš„æƒé™ï¼Œä¿®æ”¹åæ— æ³•å†™å…¥ï¼æ‰€ä»¥ï¼š
  `å¯ä»¥è€ƒè™‘è¯»å–æœ¬åœ°æ‰“åŒ…æ—¶å€™çš„project.manifestæ–‡ä»¶ï¼Œå¹¶å°†æ–‡ä»¶ä¸­çš„åœ°å€æ”¹ä¸ºæœåŠ¡å™¨ä¸‹å‘çš„æ–°åœ°å€ï¼Œç„¶åä¸æ˜¯ä¿å­˜è¯¥æ–‡ä»¶ï¼Œè€Œæ˜¯å°†ä¿®æ”¹åçš„æ–‡ä»¶å­˜æ”¾åˆ°æˆ‘ä»¬è‡ªå·±åˆ›å»ºçš„è·¯å¾„ä¸‹(ä¹Ÿå°±æ˜¯remoteAssetsæ–‡ä»¶å¤¹ä¸‹é¢ï¼Œæˆ‘ä»¬å‘½åä¸ºproject.manifestæ–‡ä»¶)ã€‚è¿™æ ·åœ¨é¦–æ¬¡æ›´æ–°çš„æ—¶å€™ï¼ˆæœåŠ¡å™¨ä¿®æ”¹äº†åœ°å€ï¼‰ï¼Œå°±å¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„remoteAssetsæ–‡ä»¶å¤¹ä¸­project.manifestæ–‡ä»¶è¿›è¡Œæ›´æ–°äº†ã€‚`
                 


å¦‚æœä¹‹å‰å·²ç»æ›´æ–°è¿‡äº†ï¼Œåé¢æœåŠ¡å™¨æ›´æ¢è¿‡æ›´æ–°åŒ…åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸Šé¢çš„ä»£ç * if (jsb.fileUtils.isFileExist(jsb.fileUtils.getWritablePath() + 'remoteAssets/project.manifest'))*ç›´æ¥åˆ¤æ–­å¹¶æ‰¾åˆ°æ›´æ–°æ–‡ä»¶ä¸­çš„manifestæ–‡ä»¶å¹¶æ›¿æ¢ï¼Œç„¶åæ›´æ–°ã€‚
                 

```
 /**
     * ä¿®æ”¹.manifestæ–‡ä»¶
     * @param {æ–°çš„å‡çº§åŒ…åœ°å€} newAppHotUpdateUrl 
     * @param {æœ¬åœ°project.manifestæ–‡ä»¶åœ°å€} localManifestPath 
     * @param {ä¿®æ”¹manifestæ–‡ä»¶åå›è°ƒ} resultCallback 
     */
    modifyAppLoadUrlForManifestFile(newAppHotUpdateUrl, localManifestPath, resultCallback) {
        try {
            if (jsb.fileUtils.isFileExist(jsb.fileUtils.getWritablePath() + 'remoteAssets/project.manifest')) {
                console.log("æœ‰ä¸‹è½½çš„manifestæ–‡ä»¶");
                let storagePath = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + 'remoteAssets');
                console.log("StoragePath for remote asset : ", storagePath);
                let loadManifest = jsb.fileUtils.getStringFromFile(storagePath + '/project.manifest');
                let manifestObject = JSON.parse(loadManifest);
                manifestObject.packageUrl = newAppHotUpdateUrl;
                manifestObject.remoteManifestUrl = manifestObject.packageUrl + 'project.manifest';
                manifestObject.remoteVersionUrl = manifestObject.packageUrl + 'version.manifest';
                resultCallback(storagePath + '/project.manifest');
                let afterString = JSON.stringify(manifestObject);
                let isWritten = jsb.fileUtils.writeStringToFile(afterString, storagePath + '/project.manifest');
                //æ›´æ–°æ•°æ®åº“ä¸­çš„æ–°è¯·æ±‚åœ°å€ï¼Œä¸‹æ¬¡å¦‚æœæ£€æµ‹åˆ°ä¸ä¸€è‡´å°±é‡æ–°ä¿®æ”¹ manifest æ–‡ä»¶
                if (isWritten) {
                    cc.sys.localStorage.setItem("appHotUpdateUrl", newAppHotUpdateUrl);
                }
                console.log("Written Status : ", isWritten);
            } else {

                /**
                 * æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜Appä¹‹å‰æ²¡æœ‰è¿›è¡Œè¿‡çƒ­æ›´ï¼Œæ‰€ä»¥ä¸å­˜åœ¨çƒ­æ›´çš„remoteAssetsæ–‡ä»¶å¤¹ã€‚
                 */

                /**
                 * remoteAssetsæ–‡ä»¶å¤¹ä¸å­˜åœ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±ä¸»åŠ¨åˆ›å»ºâ€œremoteAssetsâ€æ–‡ä»¶å¤¹ï¼Œå¹¶å°†æ‰“åŒ…æ—¶å€™çš„project.manifestæ–‡ä»¶ä¸­å‡çº§åŒ…åœ°å€ä¿®æ”¹åï¼Œå­˜æ”¾åˆ°â€œremoteAssetsâ€æ–‡ä»¶å¤¹ä¸‹é¢ã€‚
                 */
                let initializedManifestPath = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + 'remoteAssets');
                if (!jsb.fileUtils.isDirectoryExist(initializedManifestPath)) jsb.fileUtils.createDirectory(initializedManifestPath);

                console.log("storagePath==", initializedManifestPath);
                console.log("æ²¡æœ‰ä¸‹è½½çš„manifestæ–‡ä»¶", newAppHotUpdateUrl);
                console.log("æ–°çš„åœ°å€->", newAppHotUpdateUrl);
                console.log("æœ¬åœ°manifestæ–‡ä»¶åœ°å€->", localManifestPath);
                //ä¿®æ”¹åŸå§‹manifestæ–‡ä»¶
                let originManifestPath = localManifestPath;
                let originManifest = jsb.fileUtils.getStringFromFile(originManifestPath);
                let originManifestObject = JSON.parse(originManifest);
                originManifestObject.packageUrl = newAppHotUpdateUrl;
                originManifestObject.remoteManifestUrl = originManifestObject.packageUrl + 'project.manifest';
                originManifestObject.remoteVersionUrl = originManifestObject.packageUrl + 'version.manifest';
                let afterString = JSON.stringify(originManifestObject);
                let isWritten = jsb.fileUtils.writeStringToFile(afterString, initializedManifestPath + '/project.manifest');
                resultCallback(initializedManifestPath + '/project.manifest');
                if (isWritten) {
                    cc.sys.localStorage.setItem("appHotUpdateUrl", newAppHotUpdateUrl);
                }
                console.log("Written Status : ", isWritten);
            }

        } catch (error) {
            console.log("è¯»å†™manifestæ–‡ä»¶é”™è¯¯!!!(è¯·çœ‹é”™è¯¯è¯¦æƒ…-->) ", error);
        }

    },
```

è¿˜æœ‰å…³äºä»€ä¹ˆæ—¶å€™éœ€è¦å»ä¿®æ”¹è¿™ä¸ª.manifestæ–‡ä»¶ã€‚ç”±äºé¡¹ç›®ä¸€å¯åŠ¨å°±ä¼šæ ¹æ®æœåŠ¡å™¨çš„è¿”å›å€¼å»é…ç½®é¡¹ç›®ç¯å¢ƒï¼Œè¿™å…¶ä¸­è‚¯å®šä¼šå‘Šè¯‰æˆ‘ä»¬Appæ˜¯å¦éœ€è¦æ›´æ–°ï¼Œå‡çº§åŒ…åœ°å€æ˜¯å¦æœ‰æ”¹åŠ¨ã€‚ã€‚ã€‚,å¦‚æœä¸€è‚¡è„‘åœ°æ¯æ¬¡å¯åŠ¨éƒ½å»ä¿®æ”¹.manifestæ–‡ä»¶æœªå¿…å¤ªæµªè´¹æ—¶é—´ï¼Œæ‰€ä»¥å»ºè®®å°†åŸå§‹çš„å‡çº§åŒ…åœ°å€ä¿å­˜åœ¨æœ¬åœ°ï¼Œä¸‹æ¬¡å¯åŠ¨çš„æ—¶å€™æ ¹æ®è¿”å›çš„æ•°æ®å»åˆ¤æ–­å‡çº§åŒ…åœ°å€æ˜¯å¦æœ‰æ”¹å˜ï¼Œå¦‚æœæ²¡æœ‰æ”¹å˜åˆ™ä¸å¿…ä¿®æ”¹.manifestï¼Œå¦åˆ™å°±ä¿®æ”¹.manifestæ–‡ä»¶ã€‚æä¾›APIå¦‚ä¸‹ï¼š
```
    /**
     * æ£€æµ‹æ˜¯å¦éœ€è¦ä¿®æ”¹.manifestæ–‡ä»¶ 
     * @param {æ–°çš„å‡çº§åŒ…åœ°å€} newAppHotUpdateUrl 
     * @param {æœ¬åœ°project.manifestæ–‡ä»¶åœ°å€} localManifestPath 
     * @param {ä¿®æ”¹manifestæ–‡ä»¶åå›è°ƒ} resultCallback  
     */
    checkNeedModifyManifest(newAppHotUpdateUrl, localManifestPath, resultCallback) {

        if (!cc.sys.isNative) return;  
        console.log("åŸç”Ÿå¹³å°")

        let tempUpdateUrl = cc.sys.localStorage.getItem('appHotUpdateUrl');
        //ç¬¬ä¸€æ¬¡å®‰è£…å¹¶å¯åŠ¨çš„æ—¶å€™ï¼Œæœ¬åœ°æ²¡æœ‰å­˜å‚¨â€œappHotUpdateUrlâ€,æ‰€ä»¥éœ€è¦å°†Appå†…çš„åŸå§‹å‡çº§åŒ…åœ°å€å­˜æ”¾åœ¨ä¸‹é¢
        if (!tempUpdateUrl) {
            cc.sys.localStorage.setItem("appHotUpdateUrl", cc.vv.appConfig.hotPatchUrl);
        }

        tempUpdateUrl = cc.sys.localStorage.getItem('appHotUpdateUrl');
        console.log("tempUpdateUrl : ", tempUpdateUrl);
        console.log("newAppHotUpdateUrl : ", newAppHotUpdateUrl);

        if (tempUpdateUrl) {
            //å¦‚æœæœ¬åœ°å­˜å‚¨çš„å‡çº§åŒ…åœ°å€å’ŒæœåŠ¡å™¨è¿”å›çš„å‡çº§åŒ…åœ°å€ç›¸åŒï¼Œåˆ™ä¸éœ€è¦ä¿®æ”¹.manifestæ–‡ä»¶ã€‚
            // if (tempUpdateUrl == newAppHotUpdateUrl) return;
            //å¦åˆ™ --> ä¿®æ”¹manifestæ–‡ä»¶ä¸‹è½½åœ°å€
            this.modifyAppLoadUrlForManifestFile(newAppHotUpdateUrl, localManifestPath, function(manifestPath) {
                resultCallback(manifestPath);
            });
        }
    },

```
#ä¸´æ—¶æœ‰äº‹ï¼Œå…³äºçƒ­æ›´æ–°ç»†èŠ‚æˆ‘æ™šç‚¹å†å†™ã€‚
#ä¸´æ—¶æœ‰äº‹ï¼Œå…³äºçƒ­æ›´æ–°ç»†èŠ‚æˆ‘æ™šç‚¹å†å†™ã€‚
#ä¸´æ—¶æœ‰äº‹ï¼Œå…³äºçƒ­æ›´æ–°ç»†èŠ‚æˆ‘æ™šç‚¹å†å†™ã€‚
